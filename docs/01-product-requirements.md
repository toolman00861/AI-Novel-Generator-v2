# 产品需求与用户流程（AI 小说工坊）

## 项目目标
- 提供一个可管理、可迭代的 AI 小说创作平台，支持人物设定、上下文联动与高质量生成。
- 以模块化设计，便于后续扩展与替换（如更换模型供应商）。
- 目标平台：Windows 桌面（WPF，C#/.NET）

## 角色与场景
- 创作者（作者）：管理小说与章节、配置人物与世界观、发起 AI 生成与编辑。
- 管理员（可选）：管理用户、配额、全局模型与策略。

## 核心功能
1. 文章内容管理
   - 小说（Project/Novel）：创建、编辑、删除、标签、封面、状态（草稿/发布）。
   - 章节（Chapter）：创建、编辑、删除、排序、状态（草稿/发布）。
   - 片段（Scene/Paragraph）：可选粒度（MVP 可不拆），支持批注与版本。
   - 搜索与过滤：按状态、标签、人物关联。
2. 联动上下文
   - 上下文来源：
     - 人物设定（角色档案、口吻、关系）
     - 世界观设定（时间线、地点、规则）
     - 章节摘要（自动或手动）
     - 已发布或草稿的前文片段/段落
   - 上下文选择器：用户可按范围与权重选择聚合入提示词（Context Aggregation）。
   - 上下文长度控制：根据模型的 `max_tokens` 限制做裁剪与摘要。
3. 人物设计
   - 角色档案：姓名、别名、年龄、身份、性格标签、动机、口吻与常用语、背景故事。
   - 关系网络：角色之间的关系（亲属/同事/敌对），影响上下文取样。
   - 角色与章节关联：角色在某章节的参与度、情绪、状态。
4. AI 生成
   - 模式：续写、改写、总结、大纲生成、风格迁移。
   - 提示词模板：可配置系统提示、用户提示、上下文注入位置与格式。
   - 流式输出：边生成边展示，支持中途停止与重试。
   - 安全与质量：基础敏感词过滤、最大配额、重试策略。
5. 权限与协作（MVP 可后置）
   - 用户注册/登录、JWT、角色权限。
   - 项目共享与协作编辑（后续迭代）。

## 非功能性需求
- 性能：SSE 流式生成，列表分页与懒加载；数据库索引优化。
- 可靠性：服务错误与重试；日志与审计；配额限制防止滥用。
- 安全：密钥由客户端安全输入与存储（避免硬编码）；基础输入校验与内容审查。
- 可维护性：模块化 Provider；清晰的数据模型与 API 边界。

## 关键用户流程（MVP）
1. 创建小说 → 创建章节 → 录入人物设定 → 选择上下文范围 → 发起 AI 续写 → 编辑与保存。
2. 在章节页选择某段落，点击“改写”→ 选择风格与角色口吻 → 流式预览 → 接受结果并覆盖。
3. 在人物页调整角色性格标签 → 回到章节页再次生成，角色口吻自动更新。

## 验收标准（示例）
- 能创建/编辑/删除小说与章节；列表加载 ≤ 1s（本地开发）。
- 能配置至少 3 个角色，并在生成提示中注入其口吻。
- 能通过上下文选择器控制“前文摘要 + 人物设定 + 世界观”注入，生成结果与选择相关联。
- 能通过第三方 API 发起生成并流式显示；支持停止与重试。